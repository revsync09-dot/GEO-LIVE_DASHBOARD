<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GeoLive Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="config.js"></script>
</head>
<body class="page dashboard">
  <div class="bg-grid"></div>
  <aside class="sidebar">
    <button class="sidebar-logo glow-target" type="button" aria-label="GeoLive">
      <img src="assets/logo.png" alt="GeoLive logo" />
    </button>
    <nav class="sidebar-nav">
      <a class="side-link active" href="dashboard.html" aria-label="Dashboard">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="3" y="3" width="7" height="7" rx="2"></rect>
          <rect x="14" y="3" width="7" height="7" rx="2"></rect>
          <rect x="3" y="14" width="7" height="7" rx="2"></rect>
          <rect x="14" y="14" width="7" height="7" rx="2"></rect>
        </svg>
      </a>
      <a class="side-link" href="#servers" aria-label="Servers">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="4" width="16" height="6" rx="3"></rect>
          <rect x="4" y="14" width="16" height="6" rx="3"></rect>
          <circle cx="8" cy="7" r="1"></circle>
          <circle cx="8" cy="17" r="1"></circle>
        </svg>
      </a>
    </nav>
    <div class="sidebar-avatar glow-target">
      <img src="assets/logo.png" alt="User avatar" data-user-avatar />
    </div>
    <button class="side-link logout" id="logoutBtn" type="button" aria-label="Logout">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M14 7l5 5-5 5"></path>
        <path d="M19 12H9"></path>
        <path d="M5 4h4v16H5"></path>
      </svg>
    </button>
  </aside>

  <main class="content">
    <header class="hero panel">
      <div class="hero-copy">
        <p class="eyebrow">Welcome back,</p>
        <h1 class="hero-title">
          <span id="heroFirst" class="hero-first">Geo</span>
          <span id="heroLast" class="hero-gradient">Live</span>
        </h1>
        <p class="subtext">Select a server to manage geo-widgets.</p>
      </div>
      <div class="hero-search">
        <input type="search" id="searchInput" placeholder="Search servers..." />
      </div>
    </header>

    <section class="live-section panel">
      <div class="section-head">
        <div class="section-title">
          <span class="wave-icon glow-target" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path d="M2 12c2.5 0 2.5-6 5-6s2.5 12 5 12 2.5-6 5-6 2.5 6 5 6"></path>
            </svg>
          </span>
          <span>Live Feed</span>
        </div>
        <span class="subtext" id="locationLabel">Location pending...</span>
      </div>

      <div class="feed-grid">
        <div class="panel feed-panel weather-panel">
          <div class="panel-header">
            <span class="panel-title neon-blue">Local Weather</span>
          </div>
          <div class="weather-row">
            <div class="stat-card">
              <div class="stat-icon neon-cyan">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 3a3 3 0 0 0-3 3v7a4 4 0 1 0 6 0V6a3 3 0 0 0-3-3z"></path>
                </svg>
              </div>
              <div class="stat-value" id="weather-temp">-- C</div>
              <div class="stat-label">TEMP</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon neon-blue">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M3 12h10"></path>
                  <path d="M7 8h10"></path>
                  <path d="M11 16h10"></path>
                </svg>
              </div>
              <div class="stat-value" id="weather-wind">-- km/h</div>
              <div class="stat-label">WIND</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon neon-teal">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 3C9 7 7 10 7 13a5 5 0 0 0 10 0c0-3-2-6-5-10z"></path>
                </svg>
              </div>
              <div class="stat-value" id="weather-humidity">--%</div>
              <div class="stat-label">HUMID</div>
            </div>
          </div>
        </div>

        <div class="panel feed-panel seismic-panel">
          <div class="panel-header">
            <span class="panel-title neon-blue">Seismic Activity</span>
          </div>
          <ul id="quakeList" class="quake-list">
            <li class="subtext">Loading...</li>
          </ul>
        </div>

        <div class="panel feed-panel aurora-panel">
          <div class="panel-header">
            <span class="panel-title neon-green">Aurora Forecast</span>
          </div>
          <div class="aurora-status">
            <span class="aurora-state" id="auroraStatus">Checking...</span>
            <span class="subtext" id="auroraUpdated"></span>
            <span class="subtext" id="auroraKP"></span>
          </div>
        </div>
      </div>
    </section>

    <section class="servers-section" id="servers">
      <div class="section-head">
        <div>
          <p class="eyebrow">Servers</p>
          <h3 class="section-title">Select a server</h3>
        </div>
      </div>
      <div class="server-grid" id="serverGrid"></div>
    </section>
  </main>

  <div class="location-overlay" id="locationOverlay" aria-live="polite">
    <div class="location-card panel">
      <h3>Enable Location</h3>
      <p class="subtext" id="locationMessage">Allow location access to view local weather.</p>
      <button class="btn-primary" id="locationBtn" type="button">Allow Location</button>
    </div>
  </div>

  <script type="module">
    import { ensureAuthenticated, hydrateHero, hydrateUserBadge, initGlow, initLiveFeed, logout, renderGuilds } from './app.js';
    import { getLocation } from './api.js';
    import { handleOAuthRedirect } from './oauth.js';
    import { requestLocation } from './location.js';

    (async () => {
      await handleOAuthRedirect();
      ensureAuthenticated();
      hydrateHero();
      hydrateUserBadge();
      initGlow();

      document.getElementById('logoutBtn').addEventListener('click', logout);

      const overlay = document.getElementById('locationOverlay');
      const message = document.getElementById('locationMessage');
      const button = document.getElementById('locationBtn');
      let liveFeedStarted = false;

      function showOverlay(text) {
        if (text && message) message.textContent = text;
        if (overlay) overlay.classList.add('visible');
      }

      function hideOverlay() {
        if (overlay) overlay.classList.remove('visible');
      }

      async function handleLocationRequest() {
        if (message) message.textContent = 'Requesting location...';
        const coords = await requestLocation();
        if (coords) {
          hideOverlay();
          if (!liveFeedStarted) {
            liveFeedStarted = true;
            initLiveFeed();
          }
          return;
        }
        showOverlay('Location blocked. Enable it in your browser settings.');
      }

      if (getLocation()) {
        liveFeedStarted = true;
        initLiveFeed();
      } else {
        showOverlay('Allow location access to view local weather.');
      }

      handleLocationRequest();
      if (button) {
        button.addEventListener('click', handleLocationRequest);
      }

      renderGuilds(document.getElementById('serverGrid'), document.getElementById('searchInput'));
    })();
  </script>
</body>
</html>
